<!DOCTYPE html>
<html lang="ru">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{ title | default("ИС Учёта проектов автоматизации") }}</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/styles.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
    }
  </style>
</head>

<body style="background:#f8fafc;">

  {% if request.cookies.get('user_id') %}
  <div class="d-flex" style="min-height: 100vh;">

    <!-- SIDEBAR -->
    <aside id="sidebar" style="
        width: 260px; min-height: 100vh;
        background: #0f172a;
        display: flex; flex-direction: column;
        padding: 0; flex-shrink: 0;
        position: sticky; top: 0; height: 100vh; overflow-y: auto;
    ">
      <!-- Brand -->
      <div style="padding: 20px 20px 16px;">
        <a href="/projects" class="text-decoration-none d-flex align-items-center gap-3">
          <div
            style="width:40px;height:40px;background:linear-gradient(135deg,#2563eb,#1d4ed8);border-radius:10px;display:flex;align-items:center;justify-content:center;flex-shrink:0;">
            <i class="bi bi-gear-wide-connected text-white" style="font-size:1.2rem;"></i>
          </div>
          <div>
            <div class="text-white fw-bold" style="font-size:.95rem;line-height:1.2;">ИС Проектов</div>
            <div style="font-size:.65rem;color:#475569;text-transform:uppercase;letter-spacing:1px;">Automation</div>
          </div>
        </a>
      </div>

      <div style="height:1px;background:#1e293b;margin:0 16px;"></div>

      <!-- Nav -->
      <nav style="padding:16px 12px;flex:1;">
        <div class="sidebar-label">Навигация</div>
        <a href="/projects"
          class="sidebar-link {% if '/projects' in request.url.path and '/projects/' not in request.url.path %}sidebar-link-active{% endif %}">
          <i class="bi bi-grid-1x2-fill sidebar-icon"></i><span>Проекты</span>
        </a>
        <a href="/tasks" class="sidebar-link {% if '/tasks' in request.url.path %}sidebar-link-active{% endif %}">
          <i class="bi bi-list-check sidebar-icon"></i><span>Задачи</span>
        </a>
        <a href="/leads" class="sidebar-link {% if '/leads' in request.url.path %}sidebar-link-active{% endif %}">
          <i class="bi bi-chat-dots-fill sidebar-icon"></i><span>Заявки клиентов</span>
        </a>
        <a href="/notifications"
          class="sidebar-link {% if '/notifications' in request.url.path %}sidebar-link-active{% endif %}"
          id="notif-link">
          <i class="bi bi-bell sidebar-icon"></i>
          <span>Уведомления</span>
          <span id="notif-badge" class="notif-badge d-none"></span>
        </a>

        {% if request.cookies.get('user_role') in ['head', 'pm'] %}
        <div class="sidebar-label mt-4">Управление</div>
        <a href="/users" class="sidebar-link {% if '/users' in request.url.path %}sidebar-link-active{% endif %}">
          <i class="bi bi-people-fill sidebar-icon"></i><span>Команда / Загрузка</span>
        </a>
        {% endif %}
      </nav>

      <div style="height:1px;background:#1e293b;margin:0 16px;"></div>

      <!-- User -->
      <div style="padding:14px 12px;">
        <div class="dropdown">
          <a href="#" data-bs-toggle="dropdown"
            class="text-decoration-none d-flex align-items-center gap-3 p-2 rounded-3"
            style="transition:background .2s;" onmouseover="this.style.background='#1e293b'"
            onmouseout="this.style.background='transparent'">
            <div
              style="width:36px;height:36px;background:linear-gradient(135deg,#2563eb,#7c3aed);border-radius:10px;display:flex;align-items:center;justify-content:center;font-weight:700;color:white;font-size:.9rem;flex-shrink:0;">
              {{ request.cookies.get('user_role')[0].upper() if request.cookies.get('user_role') else 'U' }}
            </div>
            <div class="flex-grow-1 overflow-hidden">
              <div class="text-white fw-semibold text-truncate" style="font-size:.85rem;">{{
                request.cookies.get('user_role') }}</div>
              <div style="font-size:.7rem;color:#64748b;">Рабочая сессия</div>
            </div>
            <i class="bi bi-chevron-up" style="color:#64748b;font-size:.7rem;"></i>
          </a>
          <ul class="dropdown-menu dropdown-menu-dark shadow-lg border-0 rounded-3 p-2"
            style="background:#1e293b;min-width:200px;">
            <li><a class="dropdown-item rounded-2 py-2" href="/profile"><i class="bi bi-person me-2"></i>Мой профиль</a>
            </li>
            <li><a class="dropdown-item rounded-2 py-2" href="/notifications"><i
                  class="bi bi-bell me-2"></i>Уведомления</a></li>
            <li>
              <hr class="dropdown-divider" style="border-color:#334155;">
            </li>
            <li><a class="dropdown-item rounded-2 py-2 text-danger fw-semibold" href="/logout"><i
                  class="bi bi-box-arrow-right me-2"></i>Выйти</a></li>
          </ul>
        </div>
      </div>
    </aside>

    <!-- MAIN -->
    <main style="flex:1;background:#f8fafc;overflow-y:auto;min-height:100vh;">
      <div class="p-4 p-xl-5">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  {% else %}
  <div style="min-height:100vh;display:flex;">
    {% block login_content %}{% endblock %}
  </div>
  {% endif %}

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/static/js/scripts.js"></script>

  {% if request.cookies.get('user_id') %}
  <script>
    // Poll notifications badge
    async function updateBadge() {
      try {
        const r = await fetch('/api/notifications/count');
        const d = await r.json();
        const badge = document.getElementById('notif-badge');
        if (d.count > 0) { badge.textContent = d.count; badge.classList.remove('d-none'); }
        else { badge.classList.add('d-none'); }
      } catch (e) { }
    }
    updateBadge();
    setInterval(updateBadge, 30000);
  </script>
  {% endif %}

  <style>
    .sidebar-label {
      font-size: .65rem;
      font-weight: 600;
      color: #475569;
      letter-spacing: 1.2px;
      text-transform: uppercase;
      padding: 0 12px;
      margin-bottom: 8px;
    }

    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      color: #64748b;
      text-decoration: none;
      font-size: .875rem;
      font-weight: 500;
      margin-bottom: 4px;
      transition: all .15s ease;
      position: relative;
    }

    .sidebar-link:hover {
      background: #1e293b;
      color: #e2e8f0;
    }

    .sidebar-link-active {
      background: #1e3a5f;
      color: #60a5fa !important;
    }

    .sidebar-icon {
      font-size: 1rem;
      width: 20px;
      text-align: center;
      flex-shrink: 0;
    }

    .notif-badge {
      background: #ef4444;
      color: #fff;
      font-size: .65rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 50px;
      margin-left: auto;
    }
  </style>
</body>

</html>